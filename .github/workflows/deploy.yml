name: Deploy to AWS EC2 with PM2

on:
  push:
    branches:
      - main  # Change this to your default branch (main, master, etc.)

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy and restart PM2
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          set -e
          
          echo "üöÄ Starting deployment..."
          
          # SSH into the server and execute deployment commands
          ssh $SSH_USER@$SSH_HOST "cd '$DEPLOY_PATH' && bash -s" << 'ENDSSH'
            set -e
            
            echo "üìç Current directory: $(pwd)"
            
            # Pull latest code from main branch
            echo "üì• Pulling latest code from main branch..."
            git pull
            
            # Stop PM2 processes
            echo "üõë Stopping PM2 processes..."
            pm2 stop all
            
            # Start PM2 processes
            echo "‚ñ∂Ô∏è Starting PM2 processes..."
            pm2 start ecosystem.config.js || pm2 start app.js || pm2 start npm -- start
            
            # Check PM2 status
            echo "üìä PM2 Status:"
            pm2 status
            
            # Show running process IDs
            echo ""
            echo "üÜî PM2 Process IDs that are running:"
            PM2_LIST=$(pm2 jlist 2>/dev/null || echo "[]")
            
            if command -v jq &> /dev/null; then
              # Extract and display process IDs using jq
              RUNNING_IDS=$(echo "$PM2_LIST" | jq -r '.[] | select(.pm2_env.status == "online") | "ID: \(.pm_id) - Name: \(.name)"' 2>/dev/null || echo "")
              if [ ! -z "$RUNNING_IDS" ]; then
                echo "$RUNNING_IDS"
              else
                echo "No running processes found"
              fi
            else
              # Alternative method without jq
              echo "$PM2_LIST" | grep -o '"pm_id":[0-9]*' | grep -o '[0-9]*' | while read id; do
                echo "ID: $id"
              done
            fi
          ENDSSH
          
          echo ""
          echo "üéâ‚ú® Deployment completed successfully! Hello World! ‚ú®üéâ"
          echo "üöÄ Your application is now live on AWS EC2!"

      - name: Capture PM2 logs on failure
        if: failure()
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          echo "üîç Capturing detailed PM2 logs due to deployment failure..."
          
          ssh $SSH_USER@$SSH_HOST "cd '$DEPLOY_PATH' && bash -s" << 'ENDSSH'
            set -e
            
            echo "=========================================="
            echo "üìä Full PM2 Status"
            echo "=========================================="
            pm2 status || echo "PM2 status command failed"
            echo ""
            
            echo "=========================================="
            echo "üìã PM2 Process List (JSON)"
            echo "=========================================="
            pm2 jlist || echo "PM2 jlist command failed"
            echo ""
            
            echo "=========================================="
            echo "üìã All PM2 Logs (Last 200 lines)"
            echo "=========================================="
            pm2 logs --lines 200 --nostream || echo "PM2 logs command failed"
            echo ""
            
            # Get all process IDs and show individual logs
            PM2_LIST=$(pm2 jlist 2>/dev/null || echo "[]")
            if [ "$PM2_LIST" != "[]" ] && [ ! -z "$PM2_LIST" ]; then
              if command -v jq &> /dev/null; then
                for id in $(echo "$PM2_LIST" | jq -r '.[] | .pm_id' 2>/dev/null); do
                  echo "=========================================="
                  echo "üìã Detailed logs for PM2 process ID: $id"
                  echo "=========================================="
                  pm2 logs $id --lines 100 --nostream || echo "Could not retrieve logs for process $id"
                  echo ""
                done
              else
                # Alternative: get IDs from PM2 status
                PM2_IDS=$(pm2 jlist 2>/dev/null | grep -o '"pm_id":[0-9]*' | grep -o '[0-9]*' || echo "")
                for id in $PM2_IDS; do
                  echo "=========================================="
                  echo "üìã Detailed logs for PM2 process ID: $id"
                  echo "=========================================="
                  pm2 logs $id --lines 100 --nostream || echo "Could not retrieve logs for process $id"
                  echo ""
                done
              fi
            fi
          ENDSSH

