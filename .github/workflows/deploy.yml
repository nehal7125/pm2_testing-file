name: Deploy to AWS EC2 with PM2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Configure SSH
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
          
          # Set default user to ubuntu if not specified
          SSH_USER=${SSH_USER:-ubuntu}
          
          # Create SSH config to force ubuntu user
          cat > ~/.ssh/config << EOF
          Host $SSH_HOST
            User $SSH_USER
            StrictHostKeyChecking no
            UserKnownHostsFile ~/.ssh/known_hosts
            PreferredAuthentications publickey
            IdentitiesOnly yes
          EOF
          chmod 600 ~/.ssh/config
          
          # Verify SSH agent has the key loaded
          echo "SSH keys loaded in agent:"
          ssh-add -l || echo "Warning: No keys found in SSH agent"
          echo ""
          echo "SSH will connect as user: $SSH_USER"

      - name: Deploy and restart PM2
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          GIT_REPO_URL: ${{ github.repositoryUrl }}
        run: |
          set -e
          
          # Ensure SSH_USER defaults to ubuntu if empty, and validate it's not root
          SSH_USER=${SSH_USER:-ubuntu}
          
          if [ "$SSH_USER" = "root" ]; then
            echo "Error: SSH_USER cannot be 'root'. Please set SSH_USER secret to 'ubuntu'"
            exit 1
          fi
          
          # Convert git:// URL to https:// if needed
          REPO_URL="$GIT_REPO_URL"
          if [[ "$REPO_URL" == git://* ]]; then
            REPO_URL=$(echo "$REPO_URL" | sed 's|git://|https://|')
          fi
          
          # Verify SSH_USER is set correctly
          echo "Using SSH user: $SSH_USER"
          echo "SSH host: $SSH_HOST"
          echo "Starting deployment to $SSH_USER@$SSH_HOST:$DEPLOY_PATH"
          
          # Use SSH config file which forces ubuntu user
          if ! ssh $SSH_HOST "DEPLOY_PATH='$DEPLOY_PATH' GIT_REPO_URL='$REPO_URL' bash -s" << 'ENDSSH'
            set -e
            
            # Create deployment directory if it doesn't exist
            if [ ! -d "$DEPLOY_PATH" ]; then
              echo "Creating deployment directory: $DEPLOY_PATH"
              mkdir -p "$DEPLOY_PATH"
            fi
            
            cd "$DEPLOY_PATH" || { echo "Error: Failed to change to directory: $DEPLOY_PATH"; exit 1; }
            
            # Initialize or update repository
            if [ ! -d ".git" ]; then
              echo "Initializing repository..."
              if [ "$(ls -A . 2>/dev/null)" ]; then
                echo "Warning: Directory is not empty. Removing existing contents..."
                rm -rf ./* ./.* 2>/dev/null || true
              fi
              git clone "$GIT_REPO_URL" .
            else
              # Update remote URL if needed
              CURRENT_REMOTE=$(git remote get-url origin 2>/dev/null || echo "")
              if [ "$CURRENT_REMOTE" != "$GIT_REPO_URL" ]; then
                echo "Updating git remote URL..."
                git remote set-url origin "$GIT_REPO_URL" 2>/dev/null || git remote add origin "$GIT_REPO_URL"
              fi
              
              echo "Pulling latest changes..."
              git pull origin main
            fi
            
            # Restart PM2 processes
            echo "Stopping PM2 processes..."
            pm2 stop all || true
            
            echo "Starting PM2 processes..."
            pm2 start ecosystem.config.js || pm2 start app.js || pm2 start npm -- start
            
            # Wait a moment for processes to initialize
            sleep 2
            
            # Get and display process IDs assigned by PM2
            echo ""
            echo "PM2 Process IDs (assigned by PM2):"
            PM2_LIST=$(pm2 jlist 2>/dev/null || echo "[]")
            if command -v jq &> /dev/null; then
              echo "$PM2_LIST" | jq -r '.[] | select(.pm2_env.status == "online") | "ID: \(.pm_id) | Name: \(.name) | Status: \(.pm2_env.status)"'
            else
              pm2 list
            fi
            
            echo ""
            echo "PM2 Status:"
            pm2 status
          ENDSSH
          then
            echo "Deployment completed successfully"
          else
            echo ""
            echo "=========================================="
            echo "SSH Connection Failed!"
            echo "=========================================="
            echo "The SSH key in SSH_PRIVATE_KEY secret appears to be authorized for 'root' user, not 'ubuntu'."
            echo ""
            echo "To fix this, you need to:"
            echo "1. Add the public key to /home/ubuntu/.ssh/authorized_keys on your EC2 server"
            echo "2. Remove it from /root/.ssh/authorized_keys (if present)"
            echo ""
            echo "Or generate a new key pair specifically for the ubuntu user."
            exit 1
          fi

      - name: Capture PM2 logs on failure
        if: failure()
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          # Ensure SSH_USER defaults to ubuntu if empty
          SSH_USER=${SSH_USER:-ubuntu}
          
          echo "Capturing PM2 logs due to deployment failure..."
          
          # Use SSH config file which forces ubuntu user
          ssh $SSH_HOST "cd '$DEPLOY_PATH' && bash -s" << 'ENDSSH'
            echo "=== PM2 Status ==="
            pm2 status || echo "PM2 status command failed"
            echo ""
            
            echo "=== PM2 Process List ==="
            pm2 jlist || echo "PM2 jlist command failed"
            echo ""
            
            echo "=== PM2 Logs (Last 200 lines) ==="
            pm2 logs --lines 200 --nostream || echo "PM2 logs command failed"
            
            # Capture individual process logs if available
            PM2_LIST=$(pm2 jlist 2>/dev/null || echo "[]")
            if [ "$PM2_LIST" != "[]" ] && [ -n "$PM2_LIST" ]; then
              if command -v jq &> /dev/null; then
                for id in $(echo "$PM2_LIST" | jq -r '.[] | .pm_id' 2>/dev/null); do
                  echo ""
                  echo "=== Logs for PM2 process ID: $id ==="
                  pm2 logs $id --lines 100 --nostream || echo "Could not retrieve logs for process $id"
                done
              fi
            fi
          ENDSSH

