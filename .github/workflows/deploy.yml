name: Deploy to AWS EC2 with PM2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
          
          # Verify SSH agent is running and has keys
          echo "SSH Agent Status:"
          ssh-add -l || echo "No keys in SSH agent"

      - name: Test SSH connection
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          echo "Testing SSH connection to $SSH_USER@$SSH_HOST..."
          ssh -v -o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts $SSH_USER@$SSH_HOST "echo 'SSH connection successful'" || {
            echo "SSH connection failed. Please verify:"
            echo "1. SSH_PRIVATE_KEY secret is correctly formatted"
            echo "2. SSH_HOST and SSH_USER secrets are correct"
            echo "3. The public key is added to ~/.ssh/authorized_keys on the server"
            exit 1
          }

      - name: Deploy and restart PM2
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          GIT_REPO_URL: ${{ github.repositoryUrl }}
        run: |
          set -e
          
          echo "Starting deployment to $SSH_HOST:$DEPLOY_PATH"
          
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts $SSH_USER@$SSH_HOST "DEPLOY_PATH='$DEPLOY_PATH' GIT_REPO_URL='$GIT_REPO_URL' bash -s" << 'ENDSSH'
            set -e
            
            # Create deployment directory if it doesn't exist
            if [ ! -d "$DEPLOY_PATH" ]; then
              echo "Creating deployment directory: $DEPLOY_PATH"
              mkdir -p "$DEPLOY_PATH"
            fi
            
            cd "$DEPLOY_PATH" || { echo "Error: Failed to change to directory: $DEPLOY_PATH"; exit 1; }
            
            # Initialize or update repository
            if [ ! -d ".git" ]; then
              echo "Initializing repository..."
              if [ "$(ls -A . 2>/dev/null)" ]; then
                echo "Warning: Directory is not empty. Removing existing contents..."
                rm -rf ./* ./.* 2>/dev/null || true
              fi
              git clone "$GIT_REPO_URL" .
            else
              # Update remote URL if needed
              CURRENT_REMOTE=$(git remote get-url origin 2>/dev/null || echo "")
              if [ "$CURRENT_REMOTE" != "$GIT_REPO_URL" ]; then
                echo "Updating git remote URL..."
                git remote set-url origin "$GIT_REPO_URL" 2>/dev/null || git remote add origin "$GIT_REPO_URL"
              fi
              
              echo "Pulling latest changes..."
              git pull origin main
            fi
            
            # Restart PM2 processes
            echo "Stopping PM2 processes..."
            pm2 stop all || true
            
            echo "Starting PM2 processes..."
            pm2 start ecosystem.config.js || pm2 start app.js || pm2 start npm -- start
            
            echo "PM2 Status:"
            pm2 status
          ENDSSH
          
          echo "Deployment completed successfully"

      - name: Capture PM2 logs on failure
        if: failure()
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          echo "Capturing PM2 logs due to deployment failure..."
          
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts $SSH_USER@$SSH_HOST "cd '$DEPLOY_PATH' && bash -s" << 'ENDSSH'
            echo "=== PM2 Status ==="
            pm2 status || echo "PM2 status command failed"
            echo ""
            
            echo "=== PM2 Process List ==="
            pm2 jlist || echo "PM2 jlist command failed"
            echo ""
            
            echo "=== PM2 Logs (Last 200 lines) ==="
            pm2 logs --lines 200 --nostream || echo "PM2 logs command failed"
            
            # Capture individual process logs if available
            PM2_LIST=$(pm2 jlist 2>/dev/null || echo "[]")
            if [ "$PM2_LIST" != "[]" ] && [ -n "$PM2_LIST" ]; then
              if command -v jq &> /dev/null; then
                for id in $(echo "$PM2_LIST" | jq -r '.[] | .pm_id' 2>/dev/null); do
                  echo ""
                  echo "=== Logs for PM2 process ID: $id ==="
                  pm2 logs $id --lines 100 --nostream || echo "Could not retrieve logs for process $id"
                done
              fi
            fi
          ENDSSH

